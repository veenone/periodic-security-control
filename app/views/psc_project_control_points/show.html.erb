<%= title "#{@control_point.full_control_id} - #{@control_point.name}" %>

<div class="contextual">
  <%= link_to l(:button_edit), edit_project_psc_control_point_path(@project, @control_point), class: 'icon icon-edit' %>
  <%= form_tag(generate_schedules_project_psc_control_point_path(@project, @control_point), method: :post, style: 'display: inline;', class: 'psc-inline-form') do %>
    <%= select_tag :year, options_for_select((Date.current.year - 1..Date.current.year + 2).to_a, Date.current.year), class: 'psc-inline-select' %>
    <%= submit_tag l(:label_psc_generate_schedules_short), class: 'small' %>
  <% end %>
</div>

<div class="psc-detail-grid">
  <div class="psc-detail-card">
    <div class="psc-detail-card-header">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="16" x2="12" y2="12"/>
        <line x1="12" y1="8" x2="12.01" y2="8"/>
      </svg>
      <h4><%= l(:label_information) %></h4>
    </div>
    <div class="psc-detail-card-content">
      <div class="psc-detail-row">
        <span class="psc-detail-label"><%= l(:field_control_id) %></span>
        <span class="psc-detail-value"><span class="psc-control-id"><%= @control_point.full_control_id %></span></span>
      </div>
      <div class="psc-detail-row">
        <span class="psc-detail-label"><%= l(:field_name) %></span>
        <span class="psc-detail-value"><%= @control_point.name %></span>
      </div>
      <div class="psc-detail-row">
        <span class="psc-detail-label"><%= l(:label_psc_category) %></span>
        <span class="psc-detail-value">
          <%= link_to "#{@category.code} - #{@category.name}", project_psc_category_path(@project, @category), class: 'psc-link-primary' %>
        </span>
      </div>
      <div class="psc-detail-row">
        <span class="psc-detail-label"><%= l(:field_owner) %></span>
        <span class="psc-detail-value"><%= @control_point.owner&.name || '-' %></span>
      </div>
      <div class="psc-detail-row">
        <span class="psc-detail-label"><%= l(:field_frequency) %></span>
        <span class="psc-detail-value">
          <span class="psc-frequency-badge psc-frequency-<%= @control_point.frequency %>"><%= @control_point.frequency_label %></span>
        </span>
      </div>
      <div class="psc-detail-row">
        <span class="psc-detail-label"><%= l(:field_tracker) %></span>
        <span class="psc-detail-value"><%= @control_point.tracker&.name || '-' %></span>
      </div>
      <div class="psc-detail-row">
        <span class="psc-detail-label"><%= l(:field_priority) %></span>
        <span class="psc-detail-value"><%= @control_point.priority&.name || '-' %></span>
      </div>
      <div class="psc-detail-row">
        <span class="psc-detail-label"><%= l(:field_assigned_to) %></span>
        <span class="psc-detail-value"><%= @control_point.assigned_to&.name || '-' %></span>
      </div>
      <div class="psc-detail-row">
        <span class="psc-detail-label"><%= l(:field_status) %></span>
        <span class="psc-detail-value">
          <% if @control_point.active %>
            <span class="psc-badge psc-badge-success"><%= l(:status_active) %></span>
          <% else %>
            <span class="psc-badge psc-badge-secondary"><%= l(:status_inactive) %></span>
          <% end %>
        </span>
      </div>
      <% if @control_point.description.present? %>
        <div class="psc-detail-row psc-detail-full">
          <span class="psc-detail-label"><%= l(:field_description) %></span>
          <div class="psc-detail-value psc-description-text"><%= simple_format(@control_point.description) %></div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="psc-detail-card">
    <div class="psc-detail-card-header">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="20" x2="18" y2="10"/>
        <line x1="12" y1="20" x2="12" y2="4"/>
        <line x1="6" y1="20" x2="6" y2="14"/>
      </svg>
      <h4><%= l(:label_statistics) %></h4>
    </div>
    <div class="psc-detail-card-content">
      <div class="psc-stats-grid">
        <div class="psc-stat-item">
          <div class="psc-stat-label"><%= l(:label_psc_last_completed) %></div>
          <div class="psc-stat-value psc-stat-small">
            <% if (last = @control_point.last_completed_schedule) %>
              <%= last.period_label %> <%= last.year %>
              <div class="psc-stat-sub">(<%= format_date(last.completed_at) %>)</div>
            <% else %>
              -
            <% end %>
          </div>
        </div>
        <div class="psc-stat-item psc-stat-danger">
          <div class="psc-stat-value"><%= @control_point.overdue_schedules_count %></div>
          <div class="psc-stat-label"><%= l(:label_psc_overdue_count) %></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="psc-section">
  <div class="psc-section-header">
    <h3 class="psc-section-title"><%= l(:label_psc_schedules) %></h3>
  </div>
  <% if @schedules.any? %>
    <table class="psc-table">
      <thead>
        <tr>
          <th><%= l(:field_year) %></th>
          <th><%= l(:field_period) %></th>
          <th><%= l(:field_scheduled_date) %></th>
          <th><%= l(:field_due_date) %></th>
          <th><%= l(:field_status) %></th>
          <th><%= l(:field_issue) %></th>
          <th><%= l(:label_actions) %></th>
        </tr>
      </thead>
      <tbody>
        <% @schedules.each do |schedule| %>
          <tr class="<%= schedule.status_css_class %>">
            <td><%= schedule.year %></td>
            <td><%= schedule.period_label %></td>
            <td><%= format_date(schedule.scheduled_date) %></td>
            <td>
              <%= format_date(schedule.due_date) %>
              <% if schedule.overdue? %>
                <span class="psc-overdue-badge"><%= l(:label_psc_days_overdue, days: schedule.days_overdue) %></span>
              <% end %>
            </td>
            <td>
              <span class="psc-status-badge psc-status-<%= schedule.status %>">
                <%= l("psc_status_#{schedule.status}") %>
              </span>
            </td>
            <td>
              <% if schedule.issue %>
                <%= link_to "##{schedule.issue.id}", issue_path(schedule.issue), class: 'psc-issue-link' %>
              <% else %>
                <span class="psc-no-issue">-</span>
              <% end %>
            </td>
            <td class="psc-actions">
              <% if schedule.pending? %>
                <%= link_to l(:label_psc_generate_issue), generate_issue_project_psc_schedule_path(@project, schedule),
                            method: :post, class: 'icon icon-add' %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <div class="psc-pagination">
      <%= pagination_links_full @schedule_pages, @schedule_count %>
    </div>
  <% else %>
    <div class="psc-empty-state psc-empty-state-small">
      <p><%= l(:label_no_data) %></p>
    </div>
  <% end %>
</div>

<div class="psc-form-actions">
  <%= link_to l(:button_back), project_psc_control_points_path(@project), class: 'psc-btn psc-btn-secondary' %>
</div>
